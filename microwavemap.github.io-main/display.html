<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>mcgill microwave map - explore</title>
  <link rel="icon" type="image/x-icon" href="microwave_favicon.jpg">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style-display.css">
</head>

<body>
  <div id="map-wrapper">
    <div id="info-panel">
      <button id="toggle-info" type="button"><</button>

      <div id="info-box">
        <img src="IMG_1775.JPG" alt="mcgill microwave map" class="title-image">

        <div id="nav-buttons">
          <button class="nav-btn" id="nav-submit" type="button">SUBMIT</button>
          <button class="nav-btn" id="nav-display" type="button">EXPLORE</button>
        </div>

        <p class="intro">
          this interactive map seeks to document every
          <span class="highlight">microwave</span>
          on mcgill's downtown campus.
        </p>

        <p class="instruction">
          <span class="highlight" style="font-size:14px;">this page is updated with contributions after submission verification.</span>
        </p>

        <p class="instruction">
          click on buildings to view all microwave logs for that building.
        </p>

        <p class="instruction">
          this map is part of the final project for class GEOG 414. contributed data supports further spatial analysis of microwaves.
        </p>

        <p class="instruction">
          top contributor is
          <span id="top-contributor-name" style="font-weight:bold; text-transform:uppercase;"></span>,
          with
          <span id="top-contributor-total" style="font-weight:bold;"></span>
          microwaves logged!
        </p>

        <p class="goal">
          questions? <a class="email-button" href="mailto:charlotte.alarie@mail.mcgill.ca">email me!</a>
        </p>
      </div>
    </div>

    <div id="map"></div>

    <div id="right-panel" class="collapsed">
      <button id="toggle-right" type="button">></button>

      <div id="right-box">
        <p class="building-title">click a building</p>
        <p class="building-subtitle">microwave logs will show up here.</p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet-labeltextcollision/leaflet-labeltextcollision.js"></script>
  <script src="submit-geojson.js"></script>

  <script>
    const map = L.map('map').setView([45.5048, -73.5769], 16);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      maxZoom: 19
    }).addTo(map);

    const bounds = L.latLngBounds(
      [45.4985, -73.5865],
      [45.5105, -73.5655]
    );
    
function openRightPanel() {
  rightPanel.classList.remove("collapsed");
  toggleRight.textContent = ">";
}
    const rightPanel = document.getElementById("right-panel");
    const rightBox = document.getElementById("right-box");
    const toggleRight = document.getElementById("toggle-right");

    function esc(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[c]));
    }

function renderBuildingLogs(buildingName, microwavesInBuilding) {
  const totalMicros = microwavesInBuilding.length;
  const totalEntries = microwavesInBuilding.reduce((sum, m) => sum + m.logs.length, 0);
  const onlyUnrestricted = !!onlyUnrestrictedMapEl?.checked;

  const cards = microwavesInBuilding
    .sort((a, b) => String(a.id).localeCompare(String(b.id)))
    .map(m => {
      const first = m.logs[0] || {};

  microwavesInBuilding = onlyUnrestricted
  ? microwavesInBuilding.filter(m => {
      const first = m.logs?.[0];
      return String(first?.key || "").trim().toLowerCase() === "unrestricted";
    })
  : microwavesInBuilding;

      const header = `
        <div class="mw-objective">
          <div><b>microwave(s):</b> ${esc(first.quantity ?? "-")}</div>
          <div><b>floor #:</b> ${esc(first.floor ?? "-")}</div>
          <div><b>room #:</b> ${esc(first.room ?? "-")}</div>
          <div><b>access:</b> ${esc(first.key ?? "-")}</div>
        </div>
      `;

      const reviews = m.logs.map((log, i) => `
        <div class="mw-review">
          <div class="mw-review-title"><b>review:</b> ${i + 1} / ${m.logs.length}</div>
          <div><b>rating:</b> ${esc(log.rating || "-")} / 5</div>
          <div><b>note:</b> ${esc(log.note || "-")}</div>
          <div><b>contributed by:</b> ${esc(log.contributor || "-")}</div>
        </div>
      `).join("");

      return `
        <div class="mw-card">
          ${header}
          ${reviews}
        </div>
      `;
    })
    .join("");

  rightBox.innerHTML = `
    <div>
      <p class="building-title">${esc(buildingName)}</p>
      <p class="building-subtitle">${totalMicros} unique microwave location logs, ${totalEntries} total log entr${totalEntries === 1 ? "y" : "ies"}</p>
      <hr>
      ${cards || "<p>no microwaves logged for this building (yet)!</p>"}
    </div>
  `;

  openRightPanel();
}

let lastClickedBuilding = null;

const FilterControl = L.Control.extend({
  options: { position: "topleft" },

  onAdd: function () {
    const container = L.DomUtil.create("div", "leaflet-control mw-filter-control");

    container.innerHTML = `
      <label class="mw-filter-toggle">
        <input type="checkbox" id="only-unrestricted-map">
        only unrestricted
      </label>
    `;

    // prevent map drag/scroll when interacting
    L.DomEvent.disableClickPropagation(container);
    L.DomEvent.disableScrollPropagation(container);

    return container;
  }
});

map.addControl(new FilterControl());

const onlyUnrestrictedMapEl = document.getElementById("only-unrestricted-map");

onlyUnrestrictedMapEl.addEventListener("change", () => {
  if (!lastClickedBuilding) return;
  const list = microwavesByBuilding[lastClickedBuilding] || [];
  renderBuildingLogs(lastClickedBuilding, list);
});
    
    let microwavesByBuilding = {}; 
    let selectedLayer = null;

    function normalizeBuildingName(s){
      return String(s || "").trim();
    }

    const buildingNameMap = {
    };

    function resolveBuildingNameFromFeature(feature){
      const raw = feature.properties.Name || feature.properties.name || "";
      const polyName = normalizeBuildingName(raw);
      return buildingNameMap[polyName] || polyName;
    }

    function highlight(layer){
      if (selectedLayer) selectedLayer.setStyle({ weight: 2, fillOpacity: 0.08 });
      selectedLayer = layer;
      layer.setStyle({ weight: 4, fillOpacity: 0.18 });
    }

    const buildingsLayer = L.geoJSON(geojsonFeature, {
      style: {
        color: "#0000ff",
        weight: 2,
        opacity: 0.9,
        fillOpacity: 0.1,
        dashArray: "1, 5"
      },
      onEachFeature: (feature, layer) => {
        layer.on("click", () => {
          const buildingName = resolveBuildingNameFromFeature(feature);
          lastClickedBuilding = buildingName;
          const list = microwavesByBuilding[buildingName] || [];
          highlight(layer);
          renderBuildingLogs(buildingName, list);
        });
      }
    }).addTo(map);

    const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaYO34fzZ7CHjhWvLbIf0040V0uHVm0jTYjit8QrFDUmrFBg643QhaL5aeL4YrvweXoPlEUH4IPQS1/pub?gid=1743035491&single=true&output=csv";

    const group = L.featureGroup().addTo(map);

    Papa.parse(sheetURL, {
      download: true,
      header: true,
      dynamicTyping: true,
      skipEmptyLines: true,
      complete: ({ data }) => {
        console.log("rows loaded:", data.length);
        if (!data.length) return;

        const microwaves = {};
        data.forEach(row => {
          const id = row.microwaveID;
          if (!id) return;

          if (!microwaves[id]) {
            microwaves[id] = {
              id: id,
              building: row.building,
              lat: parseFloat(row.lat),
              lng: parseFloat(row.long),
              logs: []
            };
          }

          microwaves[id].logs.push({
            quantity: row.quantity,
            floor: row.floor,
            room: row.room,
            key: row.key,
            note: row.note,
            contributor: row.contributor,
            rating: row.rating
          });
        });

        const byBuilding = {};
        Object.values(microwaves).forEach(m => {
          const b = String(m.building || "").trim();
          if (!b) return;
          if (!byBuilding[b]) byBuilding[b] = [];
          byBuilding[b].push(m);
        });
        microwavesByBuilding = byBuilding;

        Object.values(microwaves).forEach(m => {
          if (!Number.isFinite(m.lat) || !Number.isFinite(m.lng)) return;

          L.circleMarker([m.lat, m.lng], {
            radius: 4,
            weight: 1,
            fillOpacity: 1,
            color: "#0000ff",
            fillColor: "#fff933",
            interactive: false
          }).addTo(group);
        });

        const counts = {};
        data.forEach(r => {
          if (r.contributor && String(r.contributor).trim() !== "?") {
            const qty = Number(r.quantity) || 0;
            counts[r.contributor] = (counts[r.contributor] || 0) + qty;
          }
        });

        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
        document.getElementById("top-contributor-name").textContent = sorted[0]?.[0] || "";
        document.getElementById("top-contributor-total").textContent = sorted[0]?.[1] || 0;

        if (group.getLayers().length > 0) {
          map.fitBounds(group.getBounds(), { padding: [20, 20] });
        } else {
          map.fitBounds(bounds, { padding: [20, 20] });
        }
      },
      error: (err) => console.error("papa parse error:", err)
    });

    const panel = document.getElementById("info-panel");
    const toggleBtn = document.getElementById("toggle-info");

    toggleBtn.addEventListener("click", () => {
      panel.classList.toggle("collapsed");
      toggleBtn.textContent = panel.classList.contains("collapsed") ? ">" : "<";
    });

    toggleRight.addEventListener("click", () => {
       rightPanel.classList.toggle("collapsed");
       toggleRight.textContent = rightPanel.classList.contains("collapsed") ? "<" : ">";
    });

    document.getElementById("nav-submit").addEventListener("click", () => {
      window.location.href = "index.html";
    });

    document.getElementById("nav-display").addEventListener("click", () => {
      window.location.href = "display.html";
    });
  </script>
</body>
</html>
