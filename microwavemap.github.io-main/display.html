<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>mcgill microwave map - explore</title>
  <link rel="icon" type="image/x-icon" href="microwave_favicon.jpg">
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="style-display.css">
</head>

<body>
  <div id="map-wrapper">
    <div id="info-panel">
      <button id="toggle-info" type="button"><</button>

      <div id="info-box">
        <img src="IMG_1775.JPG" alt="mcgill microwave map" class="title-image">

        <div id="nav-buttons">
          <button class="nav-btn" id="nav-submit" type="button">SUBMIT</button>
          <button class="nav-btn" id="nav-display" type="button">EXPLORE</button>
        </div>

        <p class="instruction">
          this interactive map seeks to document every
          <span class="highlight">microwave</span>
          on mcgill's downtown campus.
        </p>

        <p class="instruction">
          <span class="highlight" style="font-size:14px;">this page is updated with contributions after submission verification.</span>
        </p>

        <p class="instruction">
          click on buildings to view all microwave logs for that building.
        </p>

        <p class="instruction">
          top contributor is
          <span id="top-contributor-name" style="font-weight:bold; text-transform:uppercase;"></span>,
          with
          <span id="top-contributor-total" style="font-weight:bold;"></span>
          microwaves logged!
        </p>

        <p class="goal">
          questions? <a class="email-button" href="mailto:charlotte.alarie@mail.mcgill.ca">email me!</a>
        </p>
      </div>
    </div>

    <div id="map"></div>

    <div id="right-panel" class="collapsed">
      <button id="toggle-right" type="button">></button>

      <div id="right-box">
        <p class="building-title">click a building</p>
        <p class="building-subtitle">microwave logs will show up here.</p>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet-labeltextcollision/leaflet-labeltextcollision.js"></script>
  <script src="submit-geojson.js"></script>

<script>

  const map = L.map("map").setView([45.5048, -73.5769], 16);

  L.tileLayer("https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png", {
    attribution: "&copy; OpenStreetMap &copy; CARTO",
    maxZoom: 19
  }).addTo(map);

  const bounds = L.latLngBounds([45.4985, -73.5865], [45.5105, -73.5655]);

  const panel = document.getElementById("info-panel");
  const toggleBtn = document.getElementById("toggle-info");

  const rightPanel = document.getElementById("right-panel");
  const rightBox = document.getElementById("right-box");
  const toggleRight = document.getElementById("toggle-right");

  function openRightPanel() {
    rightPanel.classList.remove("collapsed");
    toggleRight.textContent = ">";
  }

  function esc(s) {
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      "\"": "&quot;",
      "'": "&#39;"
    }[c]));
  }

  function isUnrestricted(log) {
    return String(log?.key || "").trim().toLowerCase() === "unrestricted";
  }

  function floorRank(floorRaw) {
    const s = String(floorRaw ?? "").trim().toLowerCase();
    if (!s) return -999;

    const bMatch = s.match(/^b\s*(\d+)/) || s.match(/basement\s*(\d+)/);
    if (bMatch) return -Number(bMatch[1] || 0);

    const xb = s.match(/^(\d+)\s*b$/);
    if (xb) return -Number(xb[1] || 0);

    if (s.includes("ground") || s === "g" || s === "gf") return 0;

    const n = s.match(/-?\d+/);
    if (n) return Number(n[0]);

    return -999;
  }

  function normalizeBuildingName(s) {
    return String(s || "").trim();
  }

  const buildingNameMap = {
  };

  function resolveBuildingNameFromFeature(feature) {
    const raw = feature.properties.Name || feature.properties.name || "";
    const polyName = normalizeBuildingName(raw);
    return buildingNameMap[polyName] || polyName;
  }

  let microwavesByBuilding = {};
  let microwavesFlat = [];
  let selectedLayer = null;
  let lastClickedBuilding = null;

  const markersAll = L.layerGroup().addTo(map);
  const markersUnrestricted = L.layerGroup();
  let activeMarkers = markersAll;

  let mode = "explore";
  let userMarker = null;
  let nearestMarker = null;
  let nearestLine = null;

  function clearDistanceGraphics() {
    if (userMarker) { map.removeLayer(userMarker); userMarker = null; }
    if (nearestMarker) { map.removeLayer(nearestMarker); nearestMarker = null; }
    if (nearestLine) { map.removeLayer(nearestLine); nearestLine = null; }
  }

  function setMode(next) {
    mode = next;
    clearDistanceGraphics();
    map.getContainer().style.cursor = (mode === "nearest") ? "crosshair" : "";

    const bExplore = document.getElementById("mode-explore");
    const bNearest = document.getElementById("mode-nearest");
    if (bExplore && bNearest) {
      bExplore.classList.toggle("active", mode === "explore");
      bNearest.classList.toggle("active", mode === "nearest");
    }
  }

  let onlyUnrestrictedMapEl = null;

  function renderBuildingLogs(buildingName, microwavesInBuilding) {
    const onlyUnrestricted = !!(onlyUnrestrictedMapEl && onlyUnrestrictedMapEl.checked);

    const filteredMicrowaves = (microwavesInBuilding || [])
      .map(m => {
        const logs = Array.isArray(m.logs) ? m.logs : [];
        const keptLogs = onlyUnrestricted ? logs.filter(isUnrestricted) : logs;
        return { ...m, logs: keptLogs };
      })
      .filter(m => m.logs.length > 0);

    const totalMicros = filteredMicrowaves.length;
    const totalEntries = filteredMicrowaves.reduce((sum, m) => sum + m.logs.length, 0);

    filteredMicrowaves.sort((a, b) => {
      const ra = floorRank(a.logs?.[0]?.floor);
      const rb = floorRank(b.logs?.[0]?.floor);
      if (rb !== ra) return rb - ra;
      return String(a.logs?.[0]?.room ?? "").localeCompare(String(b.logs?.[0]?.room ?? ""));
    });

    const cards = filteredMicrowaves.map(m => {
      const first = m.logs[0] || {};

      const header = `
        <div class="mw-objective">
          <div><b>microwave(s):</b> ${esc(first.quantity ?? "-")}</div>
          <div><b>floor #:</b> ${esc(first.floor ?? "-")}</div>
          <div><b>room #:</b> ${esc(first.room ?? "-")}</div>
          <div><b>access:</b> ${esc(first.key ?? "-")}</div>
        </div>
      `;

      const reviews = m.logs.map((log, i) => `
        <div class="mw-review">
          <div class="mw-review-title"><b>review:</b> ${i + 1} / ${m.logs.length}</div>
          <div><b>rating:</b> ${esc(log.rating || "-")} / 5</div>
          <div><b>note:</b> ${esc(log.note || "-")}</div>
          <div><b>contributed by:</b> ${esc(log.contributor || "-")}</div>
        </div>
      `).join("");

      return `
        <div class="mw-card">
          ${header}
          ${reviews}
        </div>
      `;
    }).join("");

    rightBox.innerHTML = `
      <div>
        <p class="building-title">${esc(buildingName)}</p>
        <p class="building-subtitle">
          ${totalMicros} microwave location(s), ${totalEntries} review entr${totalEntries === 1 ? "y" : "ies"}
          ${onlyUnrestricted ? " (unrestricted only)" : ""}
        </p>
        <hr>
        ${cards || "<p>no microwaves match this filter for this building.</p>"}
      </div>
    `;

    openRightPanel();
  }

  const FilterControl = L.Control.extend({
    options: { position: "topleft" },
    onAdd: function () {
      const container = L.DomUtil.create("div", "leaflet-control mw-filter-control");
      container.innerHTML = `
        <label class="mw-filter-toggle">
          <input type="checkbox" id="only-unrestricted-map">
          only unrestricted
        </label>
      `;
      L.DomEvent.disableClickPropagation(container);
      L.DomEvent.disableScrollPropagation(container);
      return container;
    }
  });

  map.addControl(new FilterControl());
  onlyUnrestrictedMapEl = document.getElementById("only-unrestricted-map");

  onlyUnrestrictedMapEl.addEventListener("change", () => {
    map.removeLayer(activeMarkers);
    activeMarkers = onlyUnrestrictedMapEl.checked ? markersUnrestricted : markersAll;
    map.addLayer(activeMarkers);

    if (lastClickedBuilding) {
      renderBuildingLogs(lastClickedBuilding, microwavesByBuilding[lastClickedBuilding] || []);
    }

    clearDistanceGraphics();
  });

  // (B) mode control (under filter)
  const ModeControl = L.Control.extend({
    options: { position: "topleft" },
    onAdd: function () {
      const container = L.DomUtil.create("div", "leaflet-control mw-mode-control");
      container.innerHTML = `
        <div class="mw-mode-title">mode</div>
        <div class="mw-mode-buttons">
          <button id="mode-explore" class="mw-map-btn active" type="button">free explore</button>
          <button id="mode-nearest" class="mw-map-btn" type="button">find nearest</button>
        </div>
      `;
      L.DomEvent.disableClickPropagation(container);
      L.DomEvent.disableScrollPropagation(container);
      return container;
    }
  });

  map.addControl(new ModeControl());
  document.getElementById("mode-explore").addEventListener("click", () => setMode("explore"));
  document.getElementById("mode-nearest").addEventListener("click", () => setMode("nearest"));


  map.on("click", (e) => {
    if (mode !== "nearest") return;
    if (!microwavesFlat.length) return;

    clearDistanceGraphics();

    userMarker = L.circleMarker(e.latlng, {
      radius: 6,
      weight: 2,
      fillOpacity: 1,
      color: "#0000ff",
      fillColor: "#fff933"
    }).addTo(map);

    const onlyUnrestricted = !!(onlyUnrestrictedMapEl && onlyUnrestrictedMapEl.checked);
    const candidates = onlyUnrestricted
      ? microwavesFlat.filter(p => isUnrestricted(p.firstLog))
      : microwavesFlat;

    if (!candidates.length) {
      rightBox.innerHTML = `
        <div>
          <p class="building-title">no matches</p>
          <p class="building-subtitle">no microwaves available under current filter.</p>
        </div>
      `;
      openRightPanel();
      return;
    }

    let best = null;
    let bestDist = Infinity;

    for (const p of candidates) {
      const d = e.latlng.distanceTo(p.latlng);
      if (d < bestDist) {
        bestDist = d;
        best = p;
      }
    }

    nearestMarker = L.circleMarker(best.latlng, {
      radius: 8,
      weight: 3,
      fillOpacity: 0.2,
      color: "#0000ff",
      fillColor: "#fff933",
      interactive: false
    }).addTo(map);

    nearestLine = L.polyline([e.latlng, best.latlng], {
      color: "#0000ff",
      weight: 2,
      dashArray: "4,6"
    }).addTo(map);

    const meters = Math.round(bestDist);
    const first = best.firstLog || {};
    const logs = Array.isArray(best.logs) ? best.logs : [];

    rightBox.innerHTML = `
      <div>
        <p class="building-title">nearest microwave</p>
        <p class="building-subtitle">${meters} m away ${onlyUnrestricted ? "(unrestricted only)" : ""}</p>
        <hr>

        <div class="mw-card">
          <div class="mw-objective">
            <div><b>building:</b> ${esc(best.building || "-")}</div>
            <div><b>microwave(s):</b> ${esc(first.quantity ?? "-")}</div>
            <div><b>floor #:</b> ${esc(first.floor ?? "-")}</div>
            <div><b>room #:</b> ${esc(first.room ?? "-")}</div>
            <div><b>access:</b> ${esc(first.key ?? "-")}</div>
          </div>

          ${logs.map((log, i) => `
            <div class="mw-review">
              <div class="mw-review-title"><b>review:</b> ${i + 1} / ${logs.length}</div>
              <div><b>rating:</b> ${esc(log.rating || "-")} / 5</div>
              <div><b>note:</b> ${esc(log.note || "-")}</div>
              <div><b>contributed by:</b> ${esc(log.contributor || "-")}</div>
            </div>
          `).join("")}
        </div>
      </div>
    `;

    openRightPanel();
  });

  function highlight(layer) {
    if (selectedLayer) selectedLayer.setStyle({ weight: 2, fillOpacity: 0.08 });
    selectedLayer = layer;
    layer.setStyle({ weight: 4, fillOpacity: 0.18 });
  }

  L.geoJSON(geojsonFeature, {
    style: {
      color: "#0000ff",
      weight: 2,
      opacity: 0.9,
      fillOpacity: 0.1,
      dashArray: "1, 5"
    },
    onEachFeature: (feature, layer) => {
      layer.on("click", () => {
        if (mode !== "explore") return;

        const buildingName = resolveBuildingNameFromFeature(feature);
        lastClickedBuilding = buildingName;

        const list = microwavesByBuilding[buildingName] || [];
        highlight(layer);
        renderBuildingLogs(buildingName, list);
      });
    }
  }).addTo(map);

  const sheetURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRaYO34fzZ7CHjhWvLbIf0040V0uHVm0jTYjit8QrFDUmrFBg643QhaL5aeL4YrvweXoPlEUH4IPQS1/pub?gid=1743035491&single=true&output=csv";

  Papa.parse(sheetURL, {
    download: true,
    header: true,
    dynamicTyping: true,
    skipEmptyLines: true,

    complete: ({ data }) => {
      if (!Array.isArray(data) || !data.length) return;

      const microwaves = {};

      data.forEach(row => {
        const id = row.microwaveID;
        if (!id) return;

        if (!microwaves[id]) {
          microwaves[id] = {
            id,
            building: row.building,
            lat: parseFloat(row.lat),
            lng: parseFloat(row.long),
            logs: []
          };
        }

        microwaves[id].logs.push({
          quantity: row.quantity,
          floor: row.floor,
          room: row.room,
          key: row.key,
          note: row.note,
          contributor: row.contributor,
          rating: row.rating
        });
      });

      const byBuilding = {};
      Object.values(microwaves).forEach(m => {
        const b = String(m.building || "").trim();
        if (!b) return;
        if (!byBuilding[b]) byBuilding[b] = [];
        byBuilding[b].push(m);
      });
      microwavesByBuilding = byBuilding;

      microwavesFlat = Object.values(microwaves)
        .filter(m => Number.isFinite(m.lat) && Number.isFinite(m.lng))
        .map(m => ({
          latlng: L.latLng(m.lat, m.lng),
          building: m.building,
          firstLog: m.logs?.[0] || {},
          logs: m.logs || []
        }));

      Object.values(microwaves).forEach(m => {
        if (!Number.isFinite(m.lat) || !Number.isFinite(m.lng)) return;

        const first = m.logs?.[0] || {};
        const unrestricted = isUnrestricted(first);

        const marker = L.circleMarker([m.lat, m.lng], {
          radius: 4,
          weight: 1,
          fillOpacity: 1,
          color: "#0000ff",
          fillColor: "#fff933",
          interactive: false
        });

        marker.addTo(markersAll);
        if (unrestricted) marker.addTo(markersUnrestricted);
      });

      const counts = {};
      data.forEach(r => {
        const name = String(r.contributor || "").trim();
        if (!name || name === "?") return;
        const qty = Number(r.quantity) || 0;
        counts[name] = (counts[name] || 0) + qty;
      });

      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
      document.getElementById("top-contributor-name").textContent = sorted[0]?.[0] || "";
      document.getElementById("top-contributor-total").textContent = sorted[0]?.[1] || 0;

      const b = markersAll.getLayers().length ? markersAll.getBounds() : bounds;
      map.fitBounds(b, { padding: [20, 20] });
    },

    error: (err) => console.error("papa parse error:", err)
  });

  toggleBtn.addEventListener("click", () => {
    panel.classList.toggle("collapsed");
    toggleBtn.textContent = panel.classList.contains("collapsed") ? ">" : "<";
  });

  toggleRight.addEventListener("click", () => {
    rightPanel.classList.toggle("collapsed");
    toggleRight.textContent = rightPanel.classList.contains("collapsed") ? "<" : ">";
  });

  document.getElementById("nav-submit").addEventListener("click", () => {
    window.location.href = "index.html";
  });

  document.getElementById("nav-display").addEventListener("click", () => {
    window.location.href = "display.html";
  });
</script>

</body>
</html>
